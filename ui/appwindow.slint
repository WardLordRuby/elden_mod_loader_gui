import { MainPage } from "main.slint";
import { MainLogic, SettingsLogic, DisplayMod, ColorPalette, Message, Formating } from "common.slint";
import { StandardButton } from "std-widgets.slint";

export { MainLogic, SettingsLogic, DisplayMod }

export component App inherits Window {
    in property <string> display-message;
    in property <bool> alt-std-buttons;
    property <bool> popup-visible;
    // popup-window-height = text-height + (standard-button-height + distance between text and button) + dialog boarder
    property <length> popup-window-height: msg-size.height + 39px + 13px;
    // popup-window-width = text-width + dialog boarder
    property <length> popup-window-width: msg-size.width + 13px;
    // window-height = main-page-height -? page-title-height
    property <length> window-height: mp.height - Formating.header-height;
    property <length> popup-window-x-pos: {
        if ((mp.width - popup-window-width) / 2) < 10px {
            10px
        } else {
            (mp.width - popup-window-width) / 2
        }
    };
    property <length> popup-window-y-pos: {
        if ((window-height - popup-window-height) / 2) < 0px {
            60px
        } else {
            (window-height - popup-window-height) / 2
        }
    };
    // property <length> debug-mp-height: mp.height;
    // property <length> debug-msg-height: popup-window-height;
    // property <string> debug-msg: "height calc: " + popup-window-y-pos / 1px + "\nPage Height: " + debug-mp-height / 1px + "\nDialog Height: " + popup-window-height / 1px;
    title: @tr("Elden Mod Loader");
    icon: @image-url("assets/EML-icon.png");
    // preferred-height: 381px;
    min-height: 381px;
    min-width: Formating.app-width;
    max-width: Formating.app-width;
    
    mp := MainPage {}

    callback focus-app;
    callback show-error-popup;
    callback show-confirm-popup;
    focus-app => { fs.focus() }
    show-error-popup => {
        popup-visible = true;
        err-popup.show()
    }
    show-confirm-popup => {
        popup-visible = true;
        if (!alt-std-buttons) {
            confirm-popup.show()
        } else {
            confirm-popup-2.show()
        }
    }

    msg-size := Text {
        visible: false;
        text: display-message;
        max-width: mp.width - 30px;
    }

    // Make popupWindow look nice 
    err-popup := PopupWindow {
        x: popup-window-x-pos;
        y: popup-window-y-pos;
        height: msg-size.height + 20px;
        width: msg-size.width + 20px;
        close-on-click: false;
        
        Rectangle {
            background: ColorPalette.popup-background-color;
            border-color: ColorPalette.popup-border-color;
            border-width: 1px;
        }
        
        Dialog {
            no-frame: false;
            title: @tr("Error");
            
            Text {
                text: display-message;
                max-width: mp.width - 30px;
                wrap: word-wrap;
            }

            StandardButton {
                kind: ok; 
                clicked => { 
                    popup-visible = false;
                    MainLogic.send-message(Message.esc);
                    err-popup.close()
                }
            }
        }
    }
    // Make popupWindow look nice 
    confirm-popup := PopupWindow {
        x: popup-window-x-pos;
        y: popup-window-y-pos;
        height: msg-size.height + 20px;
        width: msg-size.width + 20px;
        close-on-click: false;

        Rectangle {
            background: ColorPalette.popup-background-color;
            border-color: ColorPalette.popup-border-color;
            border-width: 1px;
        }

        Dialog {
            no-frame: false;
            title: @tr("Confirm");
            
            Text {
                text: display-message;
                max-width: mp.width - 30px;
                wrap: word-wrap;
            }
            StandardButton {
                kind: yes; 
                clicked => { 
                    MainLogic.send-message(Message.confirm);
                    confirm-popup.close()
                }
            }
            StandardButton {
                kind: cancel; 
                clicked => { 
                    MainLogic.send-message(Message.deny);
                    confirm-popup.close()
                }
            }
        }
    }
    confirm-popup-2 := PopupWindow {
        x: popup-window-x-pos;
        y: popup-window-y-pos;
        height: msg-size.height + 20px;
        width: msg-size.width + 20px;
        close-on-click: false;

        Rectangle {
            background: ColorPalette.popup-background-color;
            border-color: ColorPalette.popup-border-color;
            border-width: 1px;
        }

        Dialog {
            no-frame: false;
            title: @tr("Confirm");
            
            Text {
                text: display-message;
                max-width: mp.width - 30px;
                wrap: word-wrap;
            }
            StandardButton {
                kind: yes; 
                clicked => { 
                    MainLogic.send-message(Message.confirm);
                    confirm-popup-2.close()
                }
            }
            StandardButton {
                kind: no; 
                clicked => { 
                    MainLogic.send-message(Message.deny);
                    confirm-popup-2.close()
                }
            }
        }
    }
    fs := FocusScope {
        key-pressed(event) => {
            if (event.text == Key.Escape) {
                if (popup-visible) {
                    popup-visible = false;
                    MainLogic.send-message(Message.esc);
                    err-popup.close();
                    confirm-popup.close();
                    confirm-popup-2.close()
                } else {
                    MainLogic.current-subpage = 0
                }
            }
            if (event.text == Key.Tab) {
                if (!popup-visible) {
                    mp.focus-line-edit()
                }
            }
            accept
        }
    }
}